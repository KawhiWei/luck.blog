# 协程编程 
  协程，是一种比线程更加轻量级的存在。正如一个进程可以拥有多个线程一样，一个线程也可以拥有多个协程。最重要的是，协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态中执行）。这样带来的好处就是性能得到了很大的提升，不会像线程切换那样消耗资源。协程是一种用户态的轻量级线程。协程的调度完全由用户控制，协程拥有自己的寄存器上下文和栈。协程调度切换时，将寄存器上下文和栈保存到其它地方，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快。
  + ## 进程与协程的比较
    + 一个线程可以有多个协程，一个进程也可以单独拥有多个协程；
    + 线程进程都是同步机制，而协程则是异步机制；
    + 协程能保留上一次调用的状态，每次重入时，就相当于进入上一次调用的状态；
  + ## 协程的类型
    协程的实现分为有栈协程（stackful）和无栈协程（stackless）两种。有栈协程指每个协程会保存单独的上下文（执行栈、寄存器等），协程的唤醒和挂起就是拷贝、切换上下文；无栈协程指单个线程内所有协程都共享同一个执行栈，协程的切换就是简单的函数返回。
    + 有栈协程的优点
      + 1.每个协程有单独的上下文，可以在任意的嵌套函数中任何地方挂起此协程
      + 2.不需要编译器做语法支持，通过汇编指令即可实现
    + 无栈协程
      + 1. 不需要为每个协程保存单独的上下文，内存占用低
      + 2. 切换成本低，性能更高
  + 协程的实现
    + 单从实现上看，有栈协程更接近于内核级线程，都需要为每个线程保存单独的上下文（寄存器、栈等），区别在于有栈协程的调度由应用程序自行实现，对内核是透明的，而内核级线程的调度由系统内核完成，是抢占式的。
    + 无栈协程的优点在性能上，不需要保存单独的上下文，内存占用低，切换成本低，性能高。缺点是需要编译器提供语义支持，比如C#的async\await和C# yield return语法糖，由编译器生成对应的代码。无栈协程是通过编译器将生成器改写为对应的迭代器类型（内部实现是一个状态机），只有在生成器内部的yield return会被作为一个单独的状态机状态。